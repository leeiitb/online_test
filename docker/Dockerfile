FROM centos:latest

MAINTAINER FOSSEE <pythonsupport@fossee.in>

RUN  rm -fr /etc/localtime && ln -s /usr/share/zoneinfo/Asia/Kolkata /etc/localtime && echo "fastestmirror=true" >> /etc/dnf/dnf.conf && rm -r /var/cache/dnf && /usr/bin/dnf clean all && rm -r /var/cache/dnf && /usr/bin/dnf -y upgrade && /usr/bin/dnf -y install bash && /usr/bin/dnf -y install epel-release info man-db filesystem dnf-utils && /usr/bin/yum-config-manager --enable centosplus && /usr/bin/yum-config-manager --enable PowerTools && /usr/bin/yum-config-manager --enable epel && /usr/bin/yum-config-manager --enable epel-testing && /usr/bin/yum-config-manager --enable epel-playground  && mkdir -p /usr/share/info /usr/share/doc /usr/share/man usr/share/locale && dnf update -y && /usr/bin/dnf install sudo scl-utils python3-pip python3-devel git python3-numpy python3-scipy git freetype-devel libpng-devel gcc-c++ gcc gcc-gfortran make python3-matplotlib mariadb-devel java-1.8.0-openjdk java-1.8.0-openjdk-devel Xaw3d-devel Xaw3d bash-completion libpng libpng12 xorg-x11-xauth adwaita-gtk3-theme gcc gcc-c++ gcc-gfortran libxml2-devel pcre-devel ncurses-devel hdf5-devel blas-devel atlas atlas-devel lapack-devel arpack arpack-devel ant apache-commons-logging tcl tcl-devel tk tk-devel libX11-devel ocaml gettext fftw3 suitesparse swig autoconf automake libtool ocaml-ocamlbuild-devel ocaml Xaw3d-devel Xaw3d bash-completion vim libpng libpng12 xorg-x11-xauth adwaita-gtk3-theme wget libpng12 vte291-devel vte291 java-1.8.0-openjdk compat-openssl10 platform-python-devel libnsl glibc-langpack-en -y && dnf -y groupinstall 'Development Tools' && sed -i '/    unsigned int warning_count;          /a     unsigned int reconnect;'  /usr/include/mysql/mysql.h && ln -s /usr/lib64/libmariadbclient.a /usr/lib64/libmariadb.a && mkdir /Temp && cd /Temp && wget https://www.scilab.org/download/5.5.2/scilab-5.5.2.bin.linux-x86_64.tar.gz && tar -xf scilab-5.5.2.bin.linux-x86_64.tar.gz && echo -e "export PATH=\$PATH:/Temp/scilab-5.5.2/bin" >> /etc/bashrc &&  export PATH=$PATH:/Temp/scilab-5.5.2/bin && git clone https://github.com/FOSSEE/online_test.git && mkdir -p /Sites/yaksh_fossee_in/online_test  && mkdir /src && mv online_test/yaksh /src/ && pip3 install tornado six matplotlib nose psutil requests && pip3 install --upgrade setuptools && pip3 install -r /Temp/online_test/requirements/requirements-py3.txt && sed -i s/"Defaults    requiretty"/"Defaults    \!requiretty"/g /etc/sudoers && mkdir -p /src/yaksh/output /src/yaksh/data /src/yaksh/bash_files /Sites/yaksh_fossee_in/online_test/yaksh_data /Sites/ae102_fossee_in/online_test/yaksh_data /Sites/yaksh-demo_fossee_in/online_test/yaksh_data >/dev/null 2>&1 && touch /Temp/test.log && chmod 777 /Temp/test.log && chmod -R 777 /src /Sites && usermod -u 995 nobody && groupmod -g 993 nobody && chown -R nobody:nobody /src /Sites  && sed  -i 's/N_CODE_SERVERS = 5/N_CODE_SERVERS = 25/g' /src/yaksh/settings.py && ln -s /Temp/scilab-5.5.2/bin/scilab-cli /bin/ &&  ln -s /Temp/scilab-5.5.2/bin/scilab /bin/ && ln -s /Temp/scilab-5.5.2/bin/scilab-adv-cli /bin/ && ln -s /Temp/scilab-5.5.2/bin/scilab-bin /bin/ && ln -s /Temp/scilab-5.5.2/bin/scilab-cli-bin /bin/ && rm -fr /etc/localtime && export R_VERSION=3.6.3 && cd /tmp/ && curl -O https://cdn.rstudio.com/r/centos-8/pkgs/R-${R_VERSION}-1-1.x86_64.rpm && dnf -y install R-${R_VERSION}-1-1.x86_64.rpm && ln -s /opt/R/${R_VERSION}/bin/R /bin/R && ln -s /opt/R/${R_VERSION}/bin/Rscript /bin/Rscript

VOLUME /Sites/yaksh_fossee_in/online_test/yaksh_data
VOLUME /Sites/ae102_fossee_in/online_test/yaksh_data

COPY ./yaksh.run.sh /src/yaksh/
COPY ./.env /src/

WORKDIR /src

CMD /usr/bin/sudo -su nobody /src/yaksh/yaksh.run.sh
